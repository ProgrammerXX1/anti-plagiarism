worker_processes  1;

events {
    worker_connections  1024;
}

http {
    # оставляем include, mime.types уже лежит внутри образа
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;
    sendfile      on;

    upstream plagio_search {
        server plagio-search:8001;
    }

    upstream plagio_ops {
        server plagio-ops:8002;
    }

    server {
        listen 80;
        server_name _;

        # все поисковые ручки через plagio-search
        location /api/search {
            proxy_pass http://plagio_search;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }

        location /api/search-raw {
            proxy_pass http://plagio_search;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }

        location /api/search-file {
            proxy_pass http://plagio_search;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }

        # всё остальное /api/* (upload, corpus, build, config и т.п.) → plagio-ops
        location /api/ {
            proxy_pass http://plagio_ops;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }
    }
}
